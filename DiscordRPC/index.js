var F=Object.create;var _=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var W=Object.getPrototypeOf,Y=Object.prototype.hasOwnProperty;var J=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),V=(n,e)=>{for(var t in e)_(n,t,{get:e[t],enumerable:!0})},w=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of H(e))!Y.call(n,r)&&r!==t&&_(n,r,{get:()=>e[r],enumerable:!(i=q(e,r))||i.enumerable});return n},p=(n,e,t)=>(w(n,e,"default"),t&&w(t,e,"default")),x=(n,e,t)=>(t=n!=null?F(W(n)):{},w(e||!n||!n.__esModule?_(t,"default",{value:n,enumerable:!0}):t,n));var T=J((K,b)=>{"use strict";var f=typeof Reflect=="object"?Reflect:null,O=f&&typeof f.apply=="function"?f.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)},m;f&&typeof f.ownKeys=="function"?m=f.ownKeys:Object.getOwnPropertySymbols?m=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:m=function(e){return Object.getOwnPropertyNames(e)};function B(n){console&&console.warn&&console.warn(n)}var R=Number.isNaN||function(e){return e!==e};function c(){c.init.call(this)}b.exports=c;b.exports.once=X;c.EventEmitter=c;c.prototype._events=void 0;c.prototype._eventsCount=0;c.prototype._maxListeners=void 0;var P=10;function v(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(c,"defaultMaxListeners",{enumerable:!0,get:function(){return P},set:function(n){if(typeof n!="number"||n<0||R(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");P=n}});c.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};c.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||R(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function C(n){return n._maxListeners===void 0?c.defaultMaxListeners:n._maxListeners}c.prototype.getMaxListeners=function(){return C(this)};c.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r=e==="error",o=this._events;if(o!==void 0)r=r&&o.error===void 0;else if(!r)return!1;if(r){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var u=o[e];if(u===void 0)return!1;if(typeof u=="function")O(u,this,t);else for(var l=u.length,D=N(u,l),i=0;i<l;++i)O(D[i],this,t);return!0};function A(n,e,t,i){var r,o,s;if(v(t),o=n._events,o===void 0?(o=n._events=Object.create(null),n._eventsCount=0):(o.newListener!==void 0&&(n.emit("newListener",e,t.listener?t.listener:t),o=n._events),s=o[e]),s===void 0)s=o[e]=t,++n._eventsCount;else if(typeof s=="function"?s=o[e]=i?[t,s]:[s,t]:i?s.unshift(t):s.push(t),r=C(n),r>0&&s.length>r&&!s.warned){s.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=n,a.type=e,a.count=s.length,B(a)}return n}c.prototype.addListener=function(e,t){return A(this,e,t,!1)};c.prototype.on=c.prototype.addListener;c.prototype.prependListener=function(e,t){return A(this,e,t,!0)};function G(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function S(n,e,t){var i={fired:!1,wrapFn:void 0,target:n,type:e,listener:t},r=G.bind(i);return r.listener=t,i.wrapFn=r,r}c.prototype.once=function(e,t){return v(t),this.on(e,S(this,e,t)),this};c.prototype.prependOnceListener=function(e,t){return v(t),this.prependListener(e,S(this,e,t)),this};c.prototype.removeListener=function(e,t){var i,r,o,s,a;if(v(t),r=this._events,r===void 0)return this;if(i=r[e],i===void 0)return this;if(i===t||i.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if(typeof i!="function"){for(o=-1,s=i.length-1;s>=0;s--)if(i[s]===t||i[s].listener===t){a=i[s].listener,o=s;break}if(o<0)return this;o===0?i.shift():Z(i,o),i.length===1&&(r[e]=i[0]),r.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};c.prototype.off=c.prototype.removeListener;c.prototype.removeAllListeners=function(e){var t,i,r;if(i=this._events,i===void 0)return this;if(i.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):i[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete i[e]),this;if(arguments.length===0){var o=Object.keys(i),s;for(r=0;r<o.length;++r)s=o[r],s!=="removeListener"&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=i[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this};function k(n,e,t){var i=n._events;if(i===void 0)return[];var r=i[e];return r===void 0?[]:typeof r=="function"?t?[r.listener||r]:[r]:t?Q(r):N(r,r.length)}c.prototype.listeners=function(e){return k(this,e,!0)};c.prototype.rawListeners=function(e){return k(this,e,!1)};c.listenerCount=function(n,e){return typeof n.listenerCount=="function"?n.listenerCount(e):M.call(n,e)};c.prototype.listenerCount=M;function M(n){var e=this._events;if(e!==void 0){var t=e[n];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}c.prototype.eventNames=function(){return this._eventsCount>0?m(this._events):[]};function N(n,e){for(var t=new Array(e),i=0;i<e;++i)t[i]=n[i];return t}function Z(n,e){for(;e+1<n.length;e++)n[e]=n[e+1];n.pop()}function Q(n){for(var e=new Array(n.length),t=0;t<e.length;++t)e[t]=n[t].listener||n[t];return e}function X(n,e){return new Promise(function(t,i){function r(s){n.removeListener(e,o),i(s)}function o(){typeof n.removeListener=="function"&&n.removeListener("error",r),t([].slice.call(arguments))}j(n,e,o,{once:!0}),e!=="error"&&ee(n,r,{once:!0})})}function ee(n,e,t){typeof n.on=="function"&&j(n,"error",e,t)}function j(n,e,t,i){if(typeof n.on=="function")i.once?n.once(e,t):n.on(e,t);else if(typeof n.addEventListener=="function")n.addEventListener(e,function r(o){i.once&&n.removeEventListener(e,r),t(o)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}var L=class extends c{constructor(e){super(),this.client=e,this.ws=null,this.tries=0}async connect(){let e=6463+this.tries%10;this.tries+=1,this.ws=new WebSocket(`ws://127.0.0.1:${e}/?v=1&client_id=${this.client.clientId}`,{origin:this.client.options.origin}),this.ws.onopen=this.onOpen.bind(this),this.ws.onclose=this.onClose.bind(this),this.ws.onerror=this.onError.bind(this),this.ws.onmessage=this.onMessage.bind(this)}onOpen(){this.emit("open")}onClose(e){e.wasClean&&this.emit("close",e)}onError(e){try{this.ws.close()}catch{}this.tries>20?this.emit("error",e.error):setTimeout(()=>{this.connect()},250)}onMessage(e){this.emit("message",JSON.parse(e.data))}send(e){this.ws.send(JSON.stringify(e))}ping(){}close(){return new Promise(e=>{this.once("close",e),this.ws.close()})}},g=class extends c{constructor(e={}){if(super(),this.options=e,this.accessToken=null,this.clientId=null,this.application=null,this.user=null,!transports[e.transport])throw new TypeError("RPC_INVALID_TRANSPORT",e.transport);this.fetch=(i,r,{data:o,query:s}={})=>fetch(`${this.fetch.endpoint}${r}${s?new URLSearchParams(s):""}`,{method:i,body:o,headers:{Authorization:`Bearer ${this.accessToken}`}}).then(async a=>{let u=await a.json();if(!a.ok){let l=new Error(a.status);throw l.body=u,l}return u}),this.fetch.endpoint="https://discord.com/api",this.transport=new L(this),this.transport.on("message",this._onRpcMessage.bind(this)),this._expecting=new Map,this._connectPromise=void 0}connect(e){return this._connectPromise?this._connectPromise:(this._connectPromise=new Promise((t,i)=>{this.clientId=e;let r=setTimeout(()=>i(new Error("RPC_CONNECTION_TIMEOUT")),1e4);r.unref(),this.once("connected",()=>{clearTimeout(r),t(this)}),this.transport.once("close",()=>{this._expecting.forEach(o=>{o.reject(new Error("connection closed"))}),this.emit("disconnected"),i(new Error("connection closed"))}),this.transport.connect().catch(i)}),this._connectPromise)}async login(e={}){let{clientId:t,accessToken:i}=e;return await this.connect(t),e.scopes?(i||(i=await this.authorize(e)),this.authenticate(i)):(this.emit("ready"),this)}request(e,t,i){return new Promise((r,o)=>{let s=uuid();this.transport.send({cmd:e,args:t,evt:i,nonce:s}),this._expecting.set(s,{resolve:r,reject:o})})}_onRpcMessage(e){if(e.cmd==="DISPATCH"&&e.evt===RPCEvents.READY)e.data.user&&(this.user=e.data.user),this.emit("connected");else if(this._expecting.has(e.nonce)){let{resolve:t,reject:i}=this._expecting.get(e.nonce);if(e.evt==="ERROR"){let r=new Error(e.data.message);r.code=e.data.code,r.data=e.data,i(r)}else t(e.data);this._expecting.delete(e.nonce)}else this.emit(e.evt,e.data)}async authorize({scopes:e,clientSecret:t,rpcToken:i,redirectUri:r,prompt:o}={}){t&&i===!0&&(i=(await this.fetch("POST","/oauth2/token/rpc",{data:new URLSearchParams({client_id:this.clientId,client_secret:t})})).rpc_token);let{code:s}=await this.request("AUTHORIZE",{scopes:e,client_id:this.clientId,prompt:o,rpc_token:i});return(await this.fetch("POST","/oauth2/token",{data:new URLSearchParams({client_id:this.clientId,client_secret:t,code:s,grant_type:"authorization_code",redirect_uri:r})})).access_token}authenticate(e){return this.request("AUTHENTICATE",{access_token:e}).then(({application:t,user:i})=>(this.accessToken=e,this.application=t,this.user=i,this.emit("ready"),this))}setActivity(e={}){let t,i,r,o;if(e.startTimestamp||e.endTimestamp){if(t={start:e.startTimestamp,end:e.endTimestamp},t.start instanceof Date&&(t.start=Math.round(t.start.getTime())),t.end instanceof Date&&(t.end=Math.round(t.end.getTime())),t.start>2147483647e3)throw new RangeError("timestamps.start must fit into a unix timestamp");if(t.end>2147483647e3)throw new RangeError("timestamps.end must fit into a unix timestamp")}return(e.largeImageKey||e.largeImageText||e.smallImageKey||e.smallImageText)&&(i={large_image:e.largeImageKey,large_text:e.largeImageText,small_image:e.smallImageKey,small_text:e.smallImageText}),(e.partySize||e.partyId||e.partyMax)&&(r={id:e.partyId},(e.partySize||e.partyMax)&&(r.size=[e.partySize,e.partyMax])),(e.matchSecret||e.joinSecret||e.spectateSecret)&&(o={match:e.matchSecret,join:e.joinSecret,spectate:e.spectateSecret}),this.request("SET_ACTIVITY",{pid:2094112,activity:{state:e.state,details:e.details,timestamps:t,assets:i,party:r,secrets:o,buttons:e.buttons,instance:!!e.instance}})}clearActivity(){return this.request("SET_ACTIVITY",{pid:2094112})}async destroy(){await this.transport.close()}};K=g});import{store as te,intercept as ne,currentMediaItem as ie}from"@neptune";import{getMediaURLFromID as re}from"@neptune/utils";var h={};V(h,{AutoClient:()=>d});var U=x(T());p(h,x(T()));var d=class extends U.default.Client{closeinterval;clientId;transport;authenticate;authorize;constructor(e){super(e),e.transport=="ws"&&this.transport.on("close",this.onClose.bind(this))}onClose(){this.closeinterval||(this.closeinterval=setInterval(()=>{this.transport.connect().then(()=>{this.closeinterval&&clearInterval(this.closeinterval),this.closeinterval=void 0}).catch(()=>{})},15e3),this.closeinterval.unref())}endlessConnect(e){return new Promise(t=>{this.clientId=e;let i=()=>{this.transport.connect(this.clientId).then(()=>{clearInterval(r)}).catch(()=>{})},r=setInterval(i,15e3);r.unref(),i(),this.once("connected",()=>{t()})})}async endlessLogin(e){if(this.options.transport!="ipc")throw new Error("Endless login is currently only supported on the IPC transport");return await this.endlessConnect(e.clientId),e.scopes?(e.accessToken||(e.accessToken=await this.authorize(e)),this.authenticate(e.accessToken)):(this.emit("ready"),this)}};import{html as se}from"@neptune/voby";import{storage as y}from"@plugin";var z=[],oe="1130698654987067493";y.keepRpcOnPause??=!0;var I=n=>n.length>=128?n.slice(0,125)+"...":n,E=new d({transport:"ws"}),$=E.endlessLogin({clientId:oe});$.then(()=>{z.push(ne("playbackControls/TIME_UPDATE",([n])=>{let e=te.getState(),{item:t,type:i}=ie;if(i!="track")return;let r=re(t.album.cover),o=new Date,s=o.getTime()/1e3|0,a=o.setSeconds(o.getSeconds()+(t.duration-n)),u=e.playbackControls.playbackState=="NOT_PLAYING";if(u&&y.keepRpcOnPause===!1)return E.clearActivity();E.setActivity({...u?{smallImageKey:"paused-icon",smallImageText:"Paused"}:{startTimestamp:s,endTimestamp:a},details:I(t.title),state:I("by "+t.artists.map(l=>l.name).join(", ")),largeImageKey:r,largeImageText:I(t.album.title)})}))});async function pe(){let n=await $;z.forEach(e=>e());try{n.clearActivity(),n.destroy()}catch{}}function me(){return se`
    <div style="display:flex;justify-content:space-between">
      <label for="keep-rpc-on-pause">Keep RPC on pause</label>
      <input
        id="keep-rpc-on-pause"
        type="checkbox"
        checked=${y.keepRpcOnPause}
        onChange=${n=>y.keepRpcOnPause=n.target.checked}
      />
    </div>
  `}export{me as Settings,pe as onUnload};
