var a=[],r=s=>s.length>=128?s.slice(0,125)+"...":s,c=!1;function y(){let s=document.styleSheets;for(let t=0;t<s.length;t++)try{let e=s[t].cssRules||s[t].rules;for(let n=0;n<e.length;n++){let o=e[n];if(o.selectorText===":root"){let i=o.style.getPropertyValue("--track-vibrant-color");if(i)return i.trim()}}}catch{console.log(`Access to stylesheet ${s[t].href} is restricted.`)}return null}var l=class{constructor(){this.ws=null,this.tries=0}async connect(){let t=6463+this.tries%10;this.tries+=1,this.ws=new WebSocket(`ws://127.0.0.1:${t}/?v=1&client_id=1130698654987067493`),this.ws.onopen=this.onOpen.bind(this),this.ws.onclose=this.onClose.bind(this),this.ws.onerror=this.onError.bind(this),this._once=[]}emit(t,e){this._once.forEach(n=>{if(n.evt==t)return n.cb(e)})}once(t,e){this._once.push({evt:t,cb:e})}onOpen(){a.push(neptune.intercept("playbackControls/TIME_UPDATE",([t])=>{if(c)return;let{item:e,type:n}=neptune.currentMediaItem;if(n!="track")return;let o=new Date,u=o.getTime()/1e3|0,i=o.setSeconds(o.getSeconds()+(e.duration-t)),p=neptune.store.getState().playbackControls.playbackState=="NOT_PLAYING";this.ws.readyState==1&&this.send({cmd:"SET_ACTIVITY",args:{pid:2094112,activity:{timestamps:{...p?{}:{start:u,end:i}},type:2,name:r(e.title),details:r("by "+e.artists.map(m=>m.name).join(", ")),assets:{large_image:`https://resources.tidal.com/images/${e.album.cover.split("-").join("/")}/80x80.jpg`,large_text:`on ${r(e.album.title)}`,small_text:y(),...p?{small_image:"paused-icon",small_text:"Paused"}:{}}}}})})),c=!0,neptune.actions.playbackControls.pause(),neptune.actions.playbackControls.play(),c=!1}onClose(t){t.wasClean&&this.emit("close",t)}onError(){a.forEach(t=>t());try{this.ws.close()}catch{}setTimeout(()=>{this.connect()},250)}send(t){this.ws.send(JSON.stringify(t))}close(){return new Promise(t=>{this.once("close",t),this.ws.close()})}},h=new l;h.connect();async function d(){if(a.forEach(s=>s()),h)try{h.close()}catch{}}export{d as onUnload};
