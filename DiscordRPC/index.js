var c=[],r=e=>e.length>=128?`${e.slice(0,125)}...`:e,a=!1;function m(){let e=document.styleSheets;for(let t=0;t<e.length;t++)try{let s=e[t].cssRules;for(let o=0;o<s.length;o++){let n=s[o];if(n.selectorText===":root"){let i=n.style.getPropertyValue("--track-vibrant-color");if(i)return i.trim()}}}catch{}return null}var l=class{constructor(){this.ws=null,this.tries=0}async connect(){let t=6463+this.tries%10;this.tries+=1,this.ws=new WebSocket(`ws://localhost:${t}/?v=1&client_id=1288341778637918208`),this.ws.onopen=this.onOpen.bind(this),this.ws.onclose=this.onClose.bind(this),this.ws.onerror=this.onError.bind(this)}onOpen(){c.push(neptune.intercept("playbackControls/TIME_UPDATE",([t])=>{if(a)return;let{item:s,type:o}=neptune.currentMediaItem;if(o!=="track")return;let n=new Date,h=n.getTime()/1e3,i=n.setSeconds(n.getSeconds()+(s.duration-t)),p=neptune.store.getState().playbackControls.playbackState==="NOT_PLAYING";this.ws.readyState===1&&this.send({cmd:"SET_ACTIVITY",args:{pid:2094112,activity:{timestamps:{...p?{}:{start:h,end:i}},type:2,name:r(s.title),details:r(`by ${s.artists.map(d=>d.name).join(", ")}`),assets:{large_image:`https://resources.tidal.com/images/${s.album.cover.split("-").join("/")}/80x80.jpg`,large_text:`on ${r(s.album.title)}`,small_text:`${m()}|${neptune.currentMediaItem.item.id}`,...p?{small_image:"paused-pause"}:{}},buttons:[{label:"Play Song",url:`https://listen.tidal.com/track/${neptune.currentMediaItem.item.id}?u`}]}}})})),a=!0,neptune.actions.playbackControls.pause(),a=!1}onClose(t){t.wasClean}onError(){for(let t of c)t();try{this.ws.close()}catch{}setTimeout(()=>{this.connect()},250)}send(t){this.ws.send(JSON.stringify(t))}close(){this.ws.close()}},u=new l;u.connect();async function y(){for(let e of c)e();if(u)try{u.close()}catch{}}export{y as onUnload};
