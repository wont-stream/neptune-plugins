import{store as g,intercept as u,currentMediaItem as w}from"@neptune";import{getMediaURLFromID as y}from"@neptune/utils";var r=[],i=s=>s.length>=128?s.slice(0,125)+"...":s,o=new a(()=>{});o.connect().then(()=>{r.push(u("playbackControls/TIME_UPDATE",([s])=>{let t=g.getState(),{item:e,type:c}=w;if(c!="track")return;let l=y(e.album.cover),n=new Date,m=n.getTime()/1e3|0,h=n.setSeconds(n.getSeconds()+(e.duration-s)),d=t.playbackControls.playbackState=="NOT_PLAYING";o.send({cmd:"SET_ACTIVITY",args:{pid:2094112,activity:{...d?{smallImageKey:"paused-icon",smallImageText:"Paused"}:{startTimestamp:m,endTimestamp:h},type:2,name:i(e.title),details:i("by "+e.artists.map(p=>p.name).join(", ")),largeImageKey:l,largeImageText:`on ${i(e.album.title)}`}}})}))});async function I(){r.forEach(s=>s());try{o.close()}catch{}}var a=class{constructor(t){this.cb=t,this.ws=null,this.tries=0}emit(t,e){this.cb(t,e)}once(t,e){this.cb(t,e)}async connect(){let t=6463+this.tries%10;this.tries+=1,this.ws=new WebSocket(`ws://127.0.0.1:${t}/?v=1&client_id=1130698654987067493`),this.ws.onopen=this.onOpen.bind(this),this.ws.onclose=this.onClose.bind(this),this.ws.onerror=this.onError.bind(this),this.ws.onmessage=this.onMessage.bind(this)}onOpen(){this.emit("open")}onClose(t){t.wasClean&&this.emit("close",t)}onError(t){try{this.ws.close()}catch{}this.tries>20?this.emit("error",t.error):setTimeout(()=>{this.connect()},250)}onMessage(t){this.emit("message",JSON.parse(t.data))}send(t){this.ws.send(JSON.stringify(t))}ping(){}close(){return new Promise(t=>{this.once("close",t),this.ws.close()})}};export{I as onUnload};
