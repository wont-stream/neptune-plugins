var c=[],i=s=>s.length>=128?s.slice(0,125)+"...":s,a=class{constructor(){this.ws=null,this.tries=0}async connect(){let t=6463+this.tries%10;this.tries+=1,this.ws=new WebSocket(`ws://127.0.0.1:${t}/?v=1&client_id=1130698654987067493`),this.ws.onopen=this.onOpen.bind(this),this.ws.onclose=this.onClose.bind(this),this.ws.onerror=this.onError.bind(this),this._once=[]}emit(t,e){this._once.forEach(n=>{if(n.evt==t)return n.cb(n)})}once(t,e){this._once.push({evt:t,cb:e})}onOpen(){c.push(neptune.intercept("playbackControls/TIME_UPDATE",([t])=>{let{item:e,type:n}=neptune.currentMediaItem;if(n!="track")return;let o=new Date,h=o.getTime()/1e3|0,p=o.setSeconds(o.getSeconds()+(e.duration-t)),l=neptune.store.getState().playbackControls.playbackState=="NOT_PLAYING";this.ws.readyState==1&&this.send({cmd:"SET_ACTIVITY",args:{pid:2094112,activity:{timestamps:{...l?{}:{start:h,end:p}},type:2,name:i(e.title),details:i("by "+e.artists.map(u=>u.name).join(", ")),assets:{large_image:`https://resources.tidal.com/images/${e.album.cover.split("-").join("/")}/80x80.jpg`,large_text:`on ${i(e.album.title)}`,...l?{small_image:"paused-icon",small_text:"Paused"}:{}}}}})})),neptune.actions.playbackControls.pause(),neptune.actions.playbackControls.play()}onClose(t){t.wasClean&&this.emit("close",t)}onError(){c.forEach(t=>t());try{this.ws.close()}catch{}setTimeout(()=>{this.connect()},250)}send(t){this.ws.send(JSON.stringify(t))}close(){return new Promise(t=>{this.once("close",t),this.ws.close()})}},r=new a;r.connect();async function m(){if(c.forEach(s=>s()),r)try{r.close()}catch{}}export{m as onUnload};
