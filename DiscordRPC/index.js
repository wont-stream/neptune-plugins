var oe=Object.create;var f=Object.defineProperty;var ce=Object.getOwnPropertyDescriptor;var Ee=Object.getOwnPropertyNames;var ae=Object.getPrototypeOf,Te=Object.prototype.hasOwnProperty;var p=(i=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(i,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):i)(function(i){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+i+'" is not supported')});var E=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports),_e=(i,e)=>{for(var t in e)f(i,t,{get:e[t],enumerable:!0})},m=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Ee(e))!Te.call(i,s)&&s!==t&&f(i,s,{get:()=>e[s],enumerable:!(n=ce(e,s))||n.enumerable});return i},A=(i,e,t)=>(m(i,e,"default"),t&&m(t,e,"default")),q=(i,e,t)=>(t=i!=null?oe(ae(i)):{},m(e||!i||!i.__esModule?f(t,"default",{value:i,enumerable:!0}):t,i));var Y=E(()=>{});var H=E(()=>{});var O=E((Ke,k)=>{"use strict";var C;try{let{app:i}=Y();C=i.setAsDefaultProtocolClient.bind(i)}catch{try{C=H()}catch{}}typeof C!="function"&&(C=()=>!1);function ue(){return typeof process<"u"?process.pid:null}var Ie=()=>{let i="";for(let e=0;e<32;e+=1){(e===8||e===12||e===16||e===20)&&(i+="-");let t;if(e===12)t=4;else{let n=Math.random()*16|0;e===16?t=n&3|0:t=n}i+=t.toString(16)}return i};k.exports={pid:ue,register:C,uuid:Ie}});var D=E((d,x)=>{"use strict";var le=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},_=le();x.exports=d=_.fetch;_.fetch&&(d.default=_.fetch.bind(_));d.Headers=_.Headers;d.Request=_.Request;d.Response=_.Response});var K=E((Fe,R)=>{"use strict";var de=p("net"),he=p("events"),pe=D(),{uuid:Ce}=O(),a={HANDSHAKE:0,FRAME:1,CLOSE:2,PING:3,PONG:4};function Ne(i){if(process.platform==="win32")return`\\\\?\\pipe\\discord-ipc-${i}`;let{env:{XDG_RUNTIME_DIR:e,TMPDIR:t,TMP:n,TEMP:s}}=process;return`${(e||t||n||s||"/tmp").replace(/\/$/,"")}/discord-ipc-${i}`}function g(i=0){return new Promise((e,t)=>{let n=Ne(i),s=()=>{i<10?e(g(i+1)):t(new Error("Could not connect"))},o=de.createConnection(n,()=>{o.removeListener("error",s),e(o)});o.once("error",s)})}async function P(i=0){if(i>30)throw new Error("Could not find endpoint");let e=`http://127.0.0.1:${6463+i%10}`;try{return(await pe(e)).status===404?e:P(i+1)}catch{return P(i+1)}}function y(i,e){e=JSON.stringify(e);let t=Buffer.byteLength(e),n=Buffer.alloc(8+t);return n.writeInt32LE(i,0),n.writeInt32LE(t,4),n.write(e,8,t),n}var u={full:"",op:void 0};function U(i,e){let t=i.read();if(!t)return;let{op:n}=u,s;if(u.full===""){n=u.op=t.readInt32LE(0);let o=t.readInt32LE(4);s=t.slice(8,o+8)}else s=t.toString();try{let o=JSON.parse(u.full+s);e({op:n,data:o}),u.full="",u.op=void 0}catch{u.full+=s}U(i,e)}var V=class extends he{constructor(e){super(),this.client=e,this.socket=null}async connect(){let e=this.socket=await g();e.on("close",this.onClose.bind(this)),e.on("error",this.onClose.bind(this)),this.emit("open"),e.write(y(a.HANDSHAKE,{v:1,client_id:this.client.clientId})),e.pause(),e.on("readable",()=>{U(e,({op:t,data:n})=>{switch(t){case a.PING:this.send(n,a.PONG);break;case a.FRAME:if(!n)return;n.cmd==="AUTHORIZE"&&n.evt!=="ERROR"&&P().then(s=>{this.client.request.endpoint=s}).catch(s=>{this.client.emit("error",s)}),this.emit("message",n);break;case a.CLOSE:this.emit("close",n);break;default:break}})})}onClose(e){this.emit("close",e)}send(e,t=a.FRAME){this.socket.write(y(t,e))}async close(){return new Promise(e=>{this.once("close",e),this.send({},a.CLOSE),this.socket.end()})}ping(){this.send(Ce(),a.PING)}};R.exports=V;R.exports.encode=y;R.exports.decode=U});var w=E(T=>{"use strict";function F(i){let e={};for(let t of i)e[t]=t;return e}T.browser=typeof window<"u";T.RPCCommands=F(["DISPATCH","AUTHORIZE","AUTHENTICATE","GET_GUILD","GET_GUILDS","GET_CHANNEL","GET_CHANNELS","CREATE_CHANNEL_INVITE","GET_RELATIONSHIPS","GET_USER","SUBSCRIBE","UNSUBSCRIBE","SET_USER_VOICE_SETTINGS","SET_USER_VOICE_SETTINGS_2","SELECT_VOICE_CHANNEL","GET_SELECTED_VOICE_CHANNEL","SELECT_TEXT_CHANNEL","GET_VOICE_SETTINGS","SET_VOICE_SETTINGS_2","SET_VOICE_SETTINGS","CAPTURE_SHORTCUT","SET_ACTIVITY","SEND_ACTIVITY_JOIN_INVITE","CLOSE_ACTIVITY_JOIN_REQUEST","ACTIVITY_INVITE_USER","ACCEPT_ACTIVITY_INVITE","INVITE_BROWSER","DEEP_LINK","CONNECTIONS_CALLBACK","BRAINTREE_POPUP_BRIDGE_CALLBACK","GIFT_CODE_BROWSER","GUILD_TEMPLATE_BROWSER","OVERLAY","BROWSER_HANDOFF","SET_CERTIFIED_DEVICES","GET_IMAGE","CREATE_LOBBY","UPDATE_LOBBY","DELETE_LOBBY","UPDATE_LOBBY_MEMBER","CONNECT_TO_LOBBY","DISCONNECT_FROM_LOBBY","SEND_TO_LOBBY","SEARCH_LOBBIES","CONNECT_TO_LOBBY_VOICE","DISCONNECT_FROM_LOBBY_VOICE","SET_OVERLAY_LOCKED","OPEN_OVERLAY_ACTIVITY_INVITE","OPEN_OVERLAY_GUILD_INVITE","OPEN_OVERLAY_VOICE_SETTINGS","VALIDATE_APPLICATION","GET_ENTITLEMENT_TICKET","GET_APPLICATION_TICKET","START_PURCHASE","GET_SKUS","GET_ENTITLEMENTS","GET_NETWORKING_CONFIG","NETWORKING_SYSTEM_METRICS","NETWORKING_PEER_METRICS","NETWORKING_CREATE_TOKEN","SET_USER_ACHIEVEMENT","GET_USER_ACHIEVEMENTS"]);T.RPCEvents=F(["CURRENT_USER_UPDATE","GUILD_STATUS","GUILD_CREATE","CHANNEL_CREATE","RELATIONSHIP_UPDATE","VOICE_CHANNEL_SELECT","VOICE_STATE_CREATE","VOICE_STATE_DELETE","VOICE_STATE_UPDATE","VOICE_SETTINGS_UPDATE","VOICE_SETTINGS_UPDATE_2","VOICE_CONNECTION_STATUS","SPEAKING_START","SPEAKING_STOP","GAME_JOIN","GAME_SPECTATE","ACTIVITY_JOIN","ACTIVITY_JOIN_REQUEST","ACTIVITY_SPECTATE","ACTIVITY_INVITE","NOTIFICATION_CREATE","MESSAGE_CREATE","MESSAGE_UPDATE","MESSAGE_DELETE","LOBBY_DELETE","LOBBY_UPDATE","LOBBY_MEMBER_CONNECT","LOBBY_MEMBER_DISCONNECT","LOBBY_MEMBER_UPDATE","LOBBY_MESSAGE","CAPTURE_SHORTCUT_CHANGE","OVERLAY","OVERLAY_UPDATE","ENTITLEMENT_CREATE","ENTITLEMENT_DELETE","USER_ACHIEVEMENT_UPDATE","READY","ERROR"]);T.RPCErrors={CAPTURE_SHORTCUT_ALREADY_LISTENING:5004,GET_GUILD_TIMED_OUT:5002,INVALID_ACTIVITY_JOIN_REQUEST:4012,INVALID_ACTIVITY_SECRET:5005,INVALID_CHANNEL:4005,INVALID_CLIENTID:4007,INVALID_COMMAND:4002,INVALID_ENTITLEMENT:4015,INVALID_EVENT:4004,INVALID_GIFT_CODE:4016,INVALID_GUILD:4003,INVALID_INVITE:4011,INVALID_LOBBY:4013,INVALID_LOBBY_SECRET:4014,INVALID_ORIGIN:4008,INVALID_PAYLOAD:4e3,INVALID_PERMISSIONS:4006,INVALID_TOKEN:4009,INVALID_USER:4010,LOBBY_FULL:5007,NO_ELIGIBLE_ACTIVITY:5006,OAUTH2_ERROR:5e3,PURCHASE_CANCELED:5008,PURCHASE_ERROR:5009,RATE_LIMITED:5011,SELECT_CHANNEL_TIMED_OUT:5001,SELECT_VOICE_FORCE_REQUIRED:5003,SERVICE_UNAVAILABLE:1001,TRANSACTION_ABORTED:1002,UNAUTHORIZED_FOR_ACHIEVEMENT:5010,UNKNOWN_ERROR:1e3};T.RPCCloseCodes={CLOSE_NORMAL:1e3,CLOSE_UNSUPPORTED:1003,CLOSE_ABNORMAL:1006,INVALID_CLIENTID:4e3,INVALID_ORIGIN:4001,RATELIMITED:4002,TOKEN_REVOKED:4003,INVALID_VERSION:4004,INVALID_ENCODING:4005};T.LobbyTypes={PRIVATE:1,PUBLIC:2};T.RelationshipTypes={NONE:0,FRIEND:1,BLOCKED:2,PENDING_INCOMING:3,PENDING_OUTGOING:4,IMPLICIT:5}});var J=E(()=>{});var z=E((ze,W)=>{"use strict";var Se=p("events"),{browser:$}=w(),Ae=$?window.WebSocket:J(),Oe=i=>JSON.stringify(i),Re=i=>JSON.parse(i),G=class extends Se{constructor(e){super(),this.client=e,this.ws=null,this.tries=0}async connect(){let e=6463+this.tries%10;this.tries+=1,this.ws=new Ae(`ws://127.0.0.1:${e}/?v=1&client_id=${this.client.clientId}`,$?void 0:{origin:this.client.options.origin}),this.ws.onopen=this.onOpen.bind(this),this.ws.onclose=this.onClose.bind(this),this.ws.onerror=this.onError.bind(this),this.ws.onmessage=this.onMessage.bind(this)}onOpen(){this.emit("open")}onClose(e){e.wasClean&&this.emit("close",e)}onError(e){try{this.ws.close()}catch{}this.tries>20?this.emit("error",e.error):setTimeout(()=>{this.connect()},250)}onMessage(e){this.emit("message",Re(e.data))}send(e){this.ws.send(Oe(e))}ping(){}close(){return new Promise(e=>{this.once("close",e),this.ws.close()})}};W.exports=G});var Q=E((je,j)=>{"use strict";j.exports={ipc:K(),websocket:z()}});var te=E((Qe,ee)=>{"use strict";var Le=p("events"),{setTimeout:me,clearTimeout:fe}=p("timers"),De=D(),Pe=Q(),{RPCCommands:r,RPCEvents:Z,RelationshipTypes:ye}=w(),{pid:X,uuid:Ve}=O();function Ue(i,e){return`${i}${JSON.stringify(e)}`}var B=class extends Le{constructor(e={}){super(),this.options=e,this.accessToken=null,this.clientId=null,this.application=null,this.user=null;let t=Pe[e.transport];if(!t)throw new TypeError("RPC_INVALID_TRANSPORT",e.transport);this.fetch=(n,s,{data:o,query:c}={})=>De(`${this.fetch.endpoint}${s}${c?new URLSearchParams(c):""}`,{method:n,body:o,headers:{Authorization:`Bearer ${this.accessToken}`}}).then(async I=>{let l=await I.json();if(!I.ok){let S=new Error(I.status);throw S.body=l,S}return l}),this.fetch.endpoint="https://discord.com/api",this.transport=new t(this),this.transport.on("message",this._onRpcMessage.bind(this)),this._expecting=new Map,this._connectPromise=void 0}connect(e){return this._connectPromise?this._connectPromise:(this._connectPromise=new Promise((t,n)=>{this.clientId=e;let s=me(()=>n(new Error("RPC_CONNECTION_TIMEOUT")),1e4);s.unref(),this.once("connected",()=>{fe(s),t(this)}),this.transport.once("close",()=>{this._expecting.forEach(o=>{o.reject(new Error("connection closed"))}),this.emit("disconnected"),n(new Error("connection closed"))}),this.transport.connect().catch(n)}),this._connectPromise)}async login(e={}){let{clientId:t,accessToken:n}=e;return await this.connect(t),e.scopes?(n||(n=await this.authorize(e)),this.authenticate(n)):(this.emit("ready"),this)}request(e,t,n){return new Promise((s,o)=>{let c=Ve();this.transport.send({cmd:e,args:t,evt:n,nonce:c}),this._expecting.set(c,{resolve:s,reject:o})})}_onRpcMessage(e){if(e.cmd===r.DISPATCH&&e.evt===Z.READY)e.data.user&&(this.user=e.data.user),this.emit("connected");else if(this._expecting.has(e.nonce)){let{resolve:t,reject:n}=this._expecting.get(e.nonce);if(e.evt==="ERROR"){let s=new Error(e.data.message);s.code=e.data.code,s.data=e.data,n(s)}else t(e.data);this._expecting.delete(e.nonce)}else this.emit(e.evt,e.data)}async authorize({scopes:e,clientSecret:t,rpcToken:n,redirectUri:s,prompt:o}={}){t&&n===!0&&(n=(await this.fetch("POST","/oauth2/token/rpc",{data:new URLSearchParams({client_id:this.clientId,client_secret:t})})).rpc_token);let{code:c}=await this.request("AUTHORIZE",{scopes:e,client_id:this.clientId,prompt:o,rpc_token:n});return(await this.fetch("POST","/oauth2/token",{data:new URLSearchParams({client_id:this.clientId,client_secret:t,code:c,grant_type:"authorization_code",redirect_uri:s})})).access_token}authenticate(e){return this.request("AUTHENTICATE",{access_token:e}).then(({application:t,user:n})=>(this.accessToken=e,this.application=t,this.user=n,this.emit("ready"),this))}getGuild(e,t){return this.request(r.GET_GUILD,{guild_id:e,timeout:t})}getGuilds(e){return this.request(r.GET_GUILDS,{timeout:e})}getChannel(e,t){return this.request(r.GET_CHANNEL,{channel_id:e,timeout:t})}async getChannels(e,t){let{channels:n}=await this.request(r.GET_CHANNELS,{timeout:t,guild_id:e});return n}setCertifiedDevices(e){return this.request(r.SET_CERTIFIED_DEVICES,{devices:e.map(t=>({type:t.type,id:t.uuid,vendor:t.vendor,model:t.model,related:t.related,echo_cancellation:t.echoCancellation,noise_suppression:t.noiseSuppression,automatic_gain_control:t.automaticGainControl,hardware_mute:t.hardwareMute}))})}setUserVoiceSettings(e,t){return this.request(r.SET_USER_VOICE_SETTINGS,{user_id:e,pan:t.pan,mute:t.mute,volume:t.volume})}selectVoiceChannel(e,{timeout:t,force:n=!1}={}){return this.request(r.SELECT_VOICE_CHANNEL,{channel_id:e,timeout:t,force:n})}selectTextChannel(e,{timeout:t}={}){return this.request(r.SELECT_TEXT_CHANNEL,{channel_id:e,timeout:t})}getVoiceSettings(){return this.request(r.GET_VOICE_SETTINGS).then(e=>({automaticGainControl:e.automatic_gain_control,echoCancellation:e.echo_cancellation,noiseSuppression:e.noise_suppression,qos:e.qos,silenceWarning:e.silence_warning,deaf:e.deaf,mute:e.mute,input:{availableDevices:e.input.available_devices,device:e.input.device_id,volume:e.input.volume},output:{availableDevices:e.output.available_devices,device:e.output.device_id,volume:e.output.volume},mode:{type:e.mode.type,autoThreshold:e.mode.auto_threshold,threshold:e.mode.threshold,shortcut:e.mode.shortcut,delay:e.mode.delay}}))}setVoiceSettings(e){return this.request(r.SET_VOICE_SETTINGS,{automatic_gain_control:e.automaticGainControl,echo_cancellation:e.echoCancellation,noise_suppression:e.noiseSuppression,qos:e.qos,silence_warning:e.silenceWarning,deaf:e.deaf,mute:e.mute,input:e.input?{device_id:e.input.device,volume:e.input.volume}:void 0,output:e.output?{device_id:e.output.device,volume:e.output.volume}:void 0,mode:e.mode?{type:e.mode.type,auto_threshold:e.mode.autoThreshold,threshold:e.mode.threshold,shortcut:e.mode.shortcut,delay:e.mode.delay}:void 0})}captureShortcut(e){let t=Ue(Z.CAPTURE_SHORTCUT_CHANGE),n=()=>(this._subscriptions.delete(t),this.request(r.CAPTURE_SHORTCUT,{action:"STOP"}));return this._subscriptions.set(t,({shortcut:s})=>{e(s,n)}),this.request(r.CAPTURE_SHORTCUT,{action:"START"}).then(()=>n)}setActivity(e={},t=X()){let n,s,o,c;if(e.startTimestamp||e.endTimestamp){if(n={start:e.startTimestamp,end:e.endTimestamp},n.start instanceof Date&&(n.start=Math.round(n.start.getTime())),n.end instanceof Date&&(n.end=Math.round(n.end.getTime())),n.start>2147483647e3)throw new RangeError("timestamps.start must fit into a unix timestamp");if(n.end>2147483647e3)throw new RangeError("timestamps.end must fit into a unix timestamp")}return(e.largeImageKey||e.largeImageText||e.smallImageKey||e.smallImageText)&&(s={large_image:e.largeImageKey,large_text:e.largeImageText,small_image:e.smallImageKey,small_text:e.smallImageText}),(e.partySize||e.partyId||e.partyMax)&&(o={id:e.partyId},(e.partySize||e.partyMax)&&(o.size=[e.partySize,e.partyMax])),(e.matchSecret||e.joinSecret||e.spectateSecret)&&(c={match:e.matchSecret,join:e.joinSecret,spectate:e.spectateSecret}),this.request(r.SET_ACTIVITY,{pid:t,activity:{state:e.state,details:e.details,timestamps:n,assets:s,party:o,secrets:c,buttons:e.buttons,instance:!!e.instance}})}clearActivity(e=X()){return this.request(r.SET_ACTIVITY,{pid:e})}sendJoinInvite(e){return this.request(r.SEND_ACTIVITY_JOIN_INVITE,{user_id:e.id||e})}sendJoinRequest(e){return this.request(r.SEND_ACTIVITY_JOIN_REQUEST,{user_id:e.id||e})}closeJoinRequest(e){return this.request(r.CLOSE_ACTIVITY_JOIN_REQUEST,{user_id:e.id||e})}createLobby(e,t,n){return this.request(r.CREATE_LOBBY,{type:e,capacity:t,metadata:n})}updateLobby(e,{type:t,owner:n,capacity:s,metadata:o}={}){return this.request(r.UPDATE_LOBBY,{id:e.id||e,type:t,owner_id:n&&n.id||n,capacity:s,metadata:o})}deleteLobby(e){return this.request(r.DELETE_LOBBY,{id:e.id||e})}connectToLobby(e,t){return this.request(r.CONNECT_TO_LOBBY,{id:e,secret:t})}sendToLobby(e,t){return this.request(r.SEND_TO_LOBBY,{id:e.id||e,data:t})}disconnectFromLobby(e){return this.request(r.DISCONNECT_FROM_LOBBY,{id:e.id||e})}updateLobbyMember(e,t,n){return this.request(r.UPDATE_LOBBY_MEMBER,{lobby_id:e.id||e,user_id:t.id||t,metadata:n})}getRelationships(){let e=Object.keys(ye);return this.request(r.GET_RELATIONSHIPS).then(t=>t.relationships.map(n=>({...n,type:e[n.type]})))}async subscribe(e,t){return await this.request(r.SUBSCRIBE,t,e),{unsubscribe:()=>this.request(r.UNSUBSCRIBE,t,e)}}async destroy(){await this.transport.close()}};ee.exports=B});var M=E((Ze,ne)=>{"use strict";var we=O();ne.exports={Client:te(),register(i){return we.register(`discord-${i}`)}}});import{store as Ge,intercept as Be,currentMediaItem as Me}from"@neptune";import{getMediaURLFromID as be}from"@neptune/utils";var h={};_e(h,{AutoClient:()=>N});var ie=q(M());A(h,q(M()));var N=class extends ie.default.Client{closeinterval;clientId;transport;authenticate;authorize;constructor(e){super(e),e.transport=="ws"&&this.transport.on("close",this.onClose.bind(this))}onClose(){this.closeinterval||(this.closeinterval=setInterval(()=>{this.transport.connect().then(()=>{this.closeinterval&&clearInterval(this.closeinterval),this.closeinterval=void 0}).catch(()=>{})},15e3),this.closeinterval.unref())}endlessConnect(e){return new Promise(t=>{this.clientId=e;let n=()=>{this.transport.connect(this.clientId).then(()=>{clearInterval(s)}).catch(()=>{})},s=setInterval(n,15e3);s.unref(),n(),this.once("connected",()=>{t()})})}async endlessLogin(e){if(this.options.transport!="ipc")throw new Error("Endless login is currently only supported on the IPC transport");return await this.endlessConnect(e.clientId),e.scopes?(e.accessToken||(e.accessToken=await this.authorize(e)),this.authenticate(e.accessToken)):(this.emit("ready"),this)}};import{html as ve}from"@neptune/voby";import{storage as L}from"@plugin";var se=[],qe="1130698654987067493";L.keepRpcOnPause??=!0;var b=i=>i.length>=128?i.slice(0,125)+"...":i,v=new N({transport:"ws"}),re=v.endlessLogin({clientId:qe});re.then(()=>{se.push(Be("playbackControls/TIME_UPDATE",([i])=>{let e=Ge.getState(),{item:t,type:n}=Me;if(n!="track")return;let s=be(t.album.cover),o=new Date,c=o.getTime()/1e3|0,I=o.setSeconds(o.getSeconds()+(t.duration-i)),l=e.playbackControls.playbackState=="NOT_PLAYING";if(l&&L.keepRpcOnPause===!1)return v.clearActivity();v.setActivity({...l?{smallImageKey:"paused-icon",smallImageText:"Paused"}:{startTimestamp:c,endTimestamp:I},details:b(t.title),state:b("by "+t.artists.map(S=>S.name).join(", ")),largeImageKey:s,largeImageText:b(t.album.title)})}))});async function rt(){let i=await re;se.forEach(e=>e());try{i.clearActivity(),i.destroy()}catch{}}function ot(){return ve`
    <div style="display:flex;justify-content:space-between">
      <label for="keep-rpc-on-pause">Keep RPC on pause</label>
      <input
        id="keep-rpc-on-pause"
        type="checkbox"
        checked=${L.keepRpcOnPause}
        onChange=${i=>L.keepRpcOnPause=i.target.checked}
      />
    </div>
  `}export{ot as Settings,rt as onUnload};
